# データフロー設計

## 概要

Umapicアプリにおけるデータの流れを定義します。

---

## 1. 記録作成フロー

### シーケンス図

```
┌─────┐     ┌─────────┐     ┌────────┐     ┌────────┐     ┌────┐
│ iOS │     │API GW   │     │Lambda  │     │DynamoDB│     │ S3 │
└──┬──┘     └────┬────┘     └───┬────┘     └───┬────┘     └─┬──┘
   │             │              │              │            │
   │ 1. 署名付きURL要求         │              │            │
   │────────────>│──────────────>│              │            │
   │             │              │              │            │
   │ 2. 署名付きURL返却         │              │            │
   │<────────────│<──────────────│              │            │
   │             │              │              │            │
   │ 3. 画像アップロード ───────────────────────────────────>│
   │             │              │              │            │
   │ 4. 記録データPOST          │              │            │
   │────────────>│──────────────>│              │            │
   │             │              │ 5. データ保存 │            │
   │             │              │─────────────>│            │
   │             │              │              │            │
   │ 6. 成功レスポンス          │              │            │
   │<────────────│<──────────────│<─────────────│            │
   │             │              │              │            │
```

### フロー詳細

| ステップ | 処理 | 詳細 |
|:---|:---|:---|
| 1 | 署名付きURL要求 | `GET /s3-upload-url?count=2` |
| 2 | URL生成・返却 | Lambda が S3 署名付きURLを生成 |
| 3 | 画像アップロード | iOS から S3 へ直接PUT |
| 4 | 記録データPOST | `POST /records` with photoKeys |
| 5 | DynamoDB保存 | 記録データをテーブルに保存 |
| 6 | レスポンス | 作成された記録のIDを返却 |

---

## 2. 記録一覧取得フロー

### シーケンス図

```
┌─────┐     ┌─────────┐     ┌────────┐     ┌────────┐     ┌──────────┐
│ iOS │     │API GW   │     │Lambda  │     │DynamoDB│     │CloudFront│
└──┬──┘     └────┬────┘     └───┬────┘     └───┬────┘     └────┬─────┘
   │             │              │              │               │
   │ 1. GET /records            │              │               │
   │────────────>│──────────────>│              │               │
   │             │              │ 2. Query     │               │
   │             │              │─────────────>│               │
   │             │              │              │               │
   │             │              │ 3. Results   │               │
   │             │              │<─────────────│               │
   │             │              │              │               │
   │ 4. 記録データ返却          │              │               │
   │<────────────│<──────────────│              │               │
   │             │              │              │               │
   │ 5. 画像取得 ─────────────────────────────────────────────>│
   │             │              │              │               │
   │ 6. 画像データ <───────────────────────────────────────────│
   │             │              │              │               │
```

### フロー詳細

| ステップ | 処理 | 詳細 |
|:---|:---|:---|
| 1 | 一覧取得リクエスト | `GET /records?sort=visitDate&order=desc&limit=20` |
| 2 | DynamoDB Query | GSI1_ByVisitDate を使用 |
| 3 | 結果取得 | 記録リストを取得 |
| 4 | レスポンス | 記録データ（photoKeysを含む）を返却 |
| 5 | 画像取得 | CloudFront URL で画像を取得 |
| 6 | 画像配信 | キャッシュまたはS3から配信 |

---

## 3. 記録詳細取得フロー

### シーケンス図

```
┌─────┐     ┌─────────┐     ┌────────┐     ┌────────┐
│ iOS │     │API GW   │     │Lambda  │     │DynamoDB│
└──┬──┘     └────┬────┘     └───┬────┘     └───┬────┘
   │             │              │              │
   │ 1. GET /records/{id}       │              │
   │────────────>│──────────────>│              │
   │             │              │ 2. GetItem   │
   │             │              │─────────────>│
   │             │              │              │
   │             │              │ 3. Item      │
   │             │              │<─────────────│
   │             │              │              │
   │ 4. 記録詳細返却            │              │
   │<────────────│<──────────────│              │
   │             │              │              │
```

---

## 4. 記録更新フロー

### シーケンス図

```
┌─────┐     ┌─────────┐     ┌────────┐     ┌────────┐     ┌────┐
│ iOS │     │API GW   │     │Lambda  │     │DynamoDB│     │ S3 │
└──┬──┘     └────┬────┘     └───┬────┘     └───┬────┘     └─┬──┘
   │             │              │              │            │
   │ 1. 新規画像がある場合：署名付きURL要求                  │
   │────────────>│──────────────>│              │            │
   │ 2. URL返却                 │              │            │
   │<────────────│<──────────────│              │            │
   │ 3. 画像アップロード ───────────────────────────────────>│
   │             │              │              │            │
   │ 4. PUT /records/{id}       │              │            │
   │────────────>│──────────────>│              │            │
   │             │              │ 5. UpdateItem│            │
   │             │              │─────────────>│            │
   │             │              │              │            │
   │             │              │ 6. 削除対象画像があれば     │
   │             │              │──────────────────────────>│
   │             │              │              │            │
   │ 7. 成功レスポンス          │              │            │
   │<────────────│<──────────────│              │            │
```

---

## 5. 記録削除フロー

### シーケンス図

```
┌─────┐     ┌─────────┐     ┌────────┐     ┌────────┐     ┌────┐
│ iOS │     │API GW   │     │Lambda  │     │DynamoDB│     │ S3 │
└──┬──┘     └────┬────┘     └───┬────┘     └───┬────┘     └─┬──┘
   │             │              │              │            │
   │ 1. DELETE /records/{id}    │              │            │
   │────────────>│──────────────>│              │            │
   │             │              │ 2. GetItem   │            │
   │             │              │─────────────>│            │
   │             │              │ 3. Item      │            │
   │             │              │<─────────────│            │
   │             │              │              │            │
   │             │              │ 4. DeleteItem│            │
   │             │              │─────────────>│            │
   │             │              │              │            │
   │             │              │ 5. 関連画像削除            │
   │             │              │──────────────────────────>│
   │             │              │              │            │
   │ 6. 成功レスポンス          │              │            │
   │<────────────│<──────────────│              │            │
```

---

## 6. 認証フロー

### サインアップ

```
┌─────┐     ┌─────────┐     ┌────────┐
│ iOS │     │ Cognito │     │   SES  │
└──┬──┘     └────┬────┘     └───┬────┘
   │             │              │
   │ 1. SignUp   │              │
   │────────────>│              │
   │             │ 2. 確認メール送信
   │             │─────────────>│
   │ 3. 確認コード入力          │
   │────────────>│              │
   │ 4. 認証完了 │              │
   │<────────────│              │
```

### ログイン

```
┌─────┐     ┌─────────┐
│ iOS │     │ Cognito │
└──┬──┘     └────┬────┘
   │             │
   │ 1. SignIn   │
   │────────────>│
   │             │
   │ 2. Tokens   │
   │ (ID, Access,│
   │  Refresh)   │
   │<────────────│
```

### API認証

```
┌─────┐     ┌─────────┐     ┌────────┐
│ iOS │     │API GW   │     │Lambda  │
└──┬──┘     └────┬────┘     └───┬────┘
   │             │              │
   │ Request     │              │
   │ + ID Token  │              │
   │────────────>│              │
   │             │ Token検証    │
   │             │──────────────│
   │             │              │
   │             │ 検証OK       │
   │             │──────────────>│
   │             │              │
```

---

## データ整合性

### 画像アップロード失敗時

| 状況 | 対応 |
|:---|:---|
| S3アップロード失敗 | クライアント側でリトライ、記録は保存しない |
| 記録保存失敗 | アップロード済み画像は孤立（定期バッチで削除） |

### 孤立画像のクリーンアップ

```
[CloudWatch Events (日次)]
        │
        ▼
[Lambda: CleanupOrphanedPhotos]
        │
        ├── S3のphotoKeysを取得
        ├── DynamoDBの有効なphotoKeysを取得
        ├── 差分を抽出
        └── 孤立画像を削除
```
